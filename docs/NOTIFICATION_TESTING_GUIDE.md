# Testing Guide - Notification Navigation Update

## Overview

This guide helps you test the updated notification navigation system with role-based routing.

## Prerequisites

‚úÖ **Before Testing:**

1. Firebase Cloud Functions deployed with latest `index.js`
2. Flutter app built with updated `notification_service.dart`
3. Test accounts for all three roles:
   - Citizen account
   - Contractor account
   - Admin account
4. Physical devices or emulators for each role
5. Firebase Console access for sending test notifications

## Test Environment Setup

### 1. Verify Cloud Functions Deployment

```bash
cd functions
firebase deploy --only functions
```

**Expected Output:**

```
‚úî  functions: Finished running predeploy script.
‚úî  functions[onComplaintStatusChange(us-central1)]: Successful update operation.
‚úî  functions[onUrgentNoticeCreated(us-central1)]: Successful update operation.
‚úî  functions[onComplaintCreated(us-central1)]: Successful update operation.
‚úî  functions[onComplaintAssigned(us-central1)]: Successful update operation.
‚úî  functions[onChatMessage(us-central1)]: Successful update operation.
‚úî  functions[onContractorChatMessage(us-central1)]: Successful update operation.
‚úî  functions[onHighPriorityNews(us-central1)]: Successful update operation.
```

### 2. Build Flutter App

```bash
# Clean previous builds
flutter clean
flutter pub get

# Run on device
flutter run
```

### 3. Prepare Test Accounts

| Role       | Email                 | Collection    |
| ---------- | --------------------- | ------------- |
| Citizen    | `citizen@test.com`    | `citizens`    |
| Contractor | `contractor@test.com` | `contractors` |
| Admin      | `admin@test.com`      | `admins`      |

## Test Cases

### Test Suite 1: Chat Notifications (Admin ‚Üê Citizen)

**Objective:** Verify admin receives chat notification from citizen and navigates to correct chat detail screen

#### Test Case 1.1: Admin Receives Message from Citizen

**Steps:**

1. Login as **Citizen** on Device A
2. Login as **Admin** on Device B
3. On Device A (Citizen):

   - Navigate to Chat screen (`/chat`)
   - Send message: "Hello Admin, I need help"
   - Wait 2-3 seconds

4. On Device B (Admin):
   - **Expected:** Notification received with title "üí¨ New Message from [Citizen Name]"
   - Tap notification
   - **Expected:** Navigate to `/admin/chat/detail` with citizen's userId
   - **Expected:** See the conversation with that specific citizen
   - **Expected:** Message "Hello Admin, I need help" is visible

**Verification Points:**

- ‚úÖ Notification received on admin device
- ‚úÖ Notification title shows citizen's name
- ‚úÖ Tapping notification opens specific chat
- ‚úÖ Not redirected to dashboard or chat list
- ‚úÖ Message is visible in the chat

**Debug Logs to Check:**

```
üì¨ New chat message for user {citizenId}
‚Üí User sent message, notifying all admins
üìù Message from citizen: {citizenName}
üì± Sending notification to X admin device(s)
‚úÖ User message notification sent to X admin device(s)
```

```
üîî Notification tapped (background)
üß≠ Notification data: {type: user_chat_message, userId: {citizenId}, ...}
üß≠ Notification type: user_chat_message
üë§ User role: UserRole.admin
```

---

### Test Suite 2: Chat Notifications (Citizen ‚Üê Admin)

**Objective:** Verify citizen receives reply from admin and navigates to their chat screen

#### Test Case 2.1: Citizen Receives Reply from Admin

**Steps:**

1. Login as **Admin** on Device A
2. Login as **Citizen** on Device B
3. On Device A (Admin):

   - Navigate to Chat Management (`/admin/chat`)
   - Select a citizen conversation
   - Send message: "Hello, how can I help you?"
   - Wait 2-3 seconds

4. On Device B (Citizen):
   - **Expected:** Notification received with title "üí¨ New Message from Admin"
   - Tap notification
   - **Expected:** Navigate to `/chat` (citizen's chat screen)
   - **Expected:** Message "Hello, how can I help you?" is visible

**Verification Points:**

- ‚úÖ Notification received on citizen device
- ‚úÖ Notification title says "from Admin"
- ‚úÖ Tapping notification opens citizen chat screen
- ‚úÖ Not redirected to dashboard
- ‚úÖ Admin's message is visible

**Debug Logs to Check:**

```
üì¨ New chat message for user {citizenId}
‚Üí Admin sent message, notifying user
‚úÖ Found user in citizen collection
üì± Found X device(s) for user {citizenId}
‚úÖ Admin message notification sent to X device(s)
```

---

### Test Suite 3: Chat Notifications (Admin ‚Üê Contractor)

**Objective:** Verify admin receives contractor message and navigates correctly

#### Test Case 3.1: Admin Receives Message from Contractor

**Steps:**

1. Login as **Contractor** on Device A
2. Login as **Admin** on Device B
3. On Device A (Contractor):

   - Navigate to Contractor Chat (`/contractor/chat`)
   - Send message: "Task completed, please review"
   - Wait 2-3 seconds

4. On Device B (Admin):
   - **Expected:** Notification with title "üí¨ New Message from [Contractor Name]"
   - Tap notification
   - **Expected:** Navigate to `/admin/chat/detail` with contractor's userId
   - **Expected:** userType argument is 'contractor'
   - **Expected:** See contractor conversation
   - **Expected:** Message visible

**Verification Points:**

- ‚úÖ Notification received on admin device
- ‚úÖ Title shows contractor's name
- ‚úÖ Navigation to correct chat detail
- ‚úÖ Contractor context is preserved
- ‚úÖ Message is visible

---

### Test Suite 4: Complaint Notifications (Admin ‚Üê Citizen)

**Objective:** Verify admin receives new complaint notification

#### Test Case 4.1: New Complaint Created

**Steps:**

1. Login as **Citizen** on Device A
2. Login as **Admin** on Device B
3. On Device A (Citizen):

   - Navigate to Submit Complaint (`/submit-complaint`)
   - Fill in complaint details:
     - Type: "Water Supply"
     - Area: "Dhanmondi 15"
     - Priority: "High"
   - Submit complaint
   - Wait 2-3 seconds

4. On Device B (Admin):
   - **Expected:** Notification "üìã New Complaint Received"
   - **Expected:** Body: "Water Supply complaint at Dhanmondi 15"
   - Tap notification
   - **Expected:** Navigate to `/admin/complaints`
   - **Expected:** New complaint visible in list

**Verification Points:**

- ‚úÖ Notification received on admin device
- ‚úÖ Complaint type and area in notification body
- ‚úÖ Tapping opens admin complaints screen
- ‚úÖ New complaint is visible
- ‚úÖ Not redirected to citizen dashboard

**Cloud Function Logs:**

```
New complaint created: {complaintId}
Sending notification to X admin device(s)
‚úÖ New complaint notification sent to X admin device(s)
```

---

### Test Suite 5: Complaint Status Updates (Citizen ‚Üê System)

**Objective:** Verify citizen receives status update and navigates to tracking

#### Test Case 5.1: Complaint Status Changed to In Progress

**Steps:**

1. Login as **Admin** on Device A
2. Login as **Citizen** on Device B (complaint owner)
3. On Device A (Admin):

   - Navigate to Complaints (`/admin/complaints`)
   - Select a complaint
   - Change status to "In Progress"
   - Save changes
   - Wait 2-3 seconds

4. On Device B (Citizen):
   - **Expected:** Notification "üîß Work in Progress"
   - **Expected:** Body mentions complaint type
   - Tap notification
   - **Expected:** Navigate to `/track-complaints`
   - **Expected:** Updated status visible

**Verification Points:**

- ‚úÖ Notification received on citizen device
- ‚úÖ Status change reflected in notification
- ‚úÖ Navigate to tracking screen
- ‚úÖ Status updated in UI
- ‚úÖ Not redirected to dashboard

---

### Test Suite 6: Task Assignment (Contractor ‚Üê Admin)

**Objective:** Verify contractor receives task assignment notification

#### Test Case 6.1: Complaint Assigned to Contractor

**Steps:**

1. Login as **Admin** on Device A
2. Login as **Contractor** on Device B
3. On Device A (Admin):

   - Navigate to Assignment (`/admin/assignment`)
   - Select a pending complaint
   - Assign to contractor
   - Save
   - Wait 2-3 seconds

4. On Device B (Contractor):
   - **Expected:** Notification "üîß New Task Assigned"
   - **Expected:** Body shows complaint type and area
   - Tap notification
   - **Expected:** Navigate to `/contractor/task-detail`
   - **Expected:** complaintId passed as argument
   - **Expected:** Task details visible

**Verification Points:**

- ‚úÖ Notification received on contractor device
- ‚úÖ Task details in notification
- ‚úÖ Navigate to task detail screen
- ‚úÖ Correct task shown
- ‚úÖ Not redirected to dashboard

---

### Test Suite 7: Urgent Notices (All Users)

**Objective:** Verify all user types receive urgent notice and navigate to respective dashboards

#### Test Case 7.1: Emergency Notice Created

**Steps:**

1. Login as **Citizen** on Device A
2. Login as **Contractor** on Device B
3. Login as **Admin** on Device C
4. As Admin in Firebase Console or code:

   - Create emergency notice in Firestore (`/notices`)
   - Set type: "emergency"
   - Set title: "Emergency: Water Supply Disruption"
   - Wait 2-3 seconds

5. Verify on each device:

**Device A (Citizen):**

- **Expected:** Notification "üö® EMERGENCY ALERT"
- Tap notification
- **Expected:** Navigate to `/dashboard`

**Device B (Contractor):**

- **Expected:** Notification "üö® EMERGENCY ALERT"
- Tap notification
- **Expected:** Navigate to `/contractor/dashboard`

**Device C (Admin):**

- **Expected:** Notification "üö® EMERGENCY ALERT"
- Tap notification
- **Expected:** Navigate to `/admin/dashboard`

**Verification Points:**

- ‚úÖ All three user types receive notification
- ‚úÖ Each navigates to their respective dashboard
- ‚úÖ Role-based routing works correctly

---

### Test Suite 8: Edge Cases

#### Test Case 8.1: Unknown Notification Type

**Steps:**

1. Send test notification from Firebase Console with custom data:
   ```json
   {
     "type": "unknown_type_xyz",
     "id": "test-123"
   }
   ```
2. Tap notification

**Expected:**

- Navigate to role-specific dashboard (fallback behavior)
- No crash or error
- Log shows: "‚ö†Ô∏è Unknown notification type: unknown_type_xyz"

#### Test Case 8.2: Missing User Role

**Steps:**

1. Logout from app
2. Send test notification
3. Tap notification

**Expected:**

- Log shows: "‚ùå No user logged in, cannot navigate"
- No navigation occurs
- No crash

#### Test Case 8.3: Missing Notification Data

**Steps:**

1. Send notification without data payload
2. Tap notification

**Expected:**

- Navigate to role-specific dashboard
- No crash
- Graceful handling

---

## Automated Testing Script

### Test Notification Sender (Node.js)

Create `test-notifications.js`:

```javascript
const admin = require("firebase-admin");
const serviceAccount = require("./serviceAccount.json");

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

// Test 1: Citizen ‚Üí Admin Chat
async function testCitizenToAdminChat(citizenId, adminToken) {
  const message = {
    notification: {
      title: "üí¨ New Message from Test Citizen",
      body: "Test message content",
    },
    data: {
      type: "user_chat_message",
      userId: citizenId,
      userType: "citizen",
      messageId: "test-msg-001",
    },
    token: adminToken,
  };

  const response = await admin.messaging().send(message);
  console.log("‚úÖ Test notification sent:", response);
}

// Test 2: Admin ‚Üí Citizen Chat
async function testAdminToCitizenChat(citizenId, citizenToken) {
  const message = {
    notification: {
      title: "üí¨ New Message from Admin",
      body: "Test admin reply",
    },
    data: {
      type: "admin_chat_message",
      userId: citizenId,
      messageId: "test-msg-002",
    },
    token: citizenToken,
  };

  const response = await admin.messaging().send(message);
  console.log("‚úÖ Test notification sent:", response);
}

// Run tests
(async () => {
  try {
    // Get FCM tokens from Firestore
    const adminDoc = await admin
      .firestore()
      .collection("admins")
      .doc("ADMIN_ID")
      .get();
    const citizenDoc = await admin
      .firestore()
      .collection("citizens")
      .doc("CITIZEN_ID")
      .get();

    const adminToken = adminDoc.data().fcmTokens[0].token;
    const citizenToken = citizenDoc.data().fcmTokens[0].token;

    console.log("Testing Citizen ‚Üí Admin Chat...");
    await testCitizenToAdminChat("CITIZEN_ID", adminToken);

    console.log("\nTesting Admin ‚Üí Citizen Chat...");
    await testAdminToCitizenChat("CITIZEN_ID", citizenToken);

    console.log("\n‚úÖ All tests completed!");
  } catch (error) {
    console.error("‚ùå Test failed:", error);
  }
})();
```

**Run:**

```bash
node test-notifications.js
```

---

## Manual Testing Checklist

### Pre-Deployment Checklist

- [ ] Cloud Functions deployed
- [ ] Flutter app built with changes
- [ ] Test accounts created for all roles
- [ ] FCM tokens verified in Firestore
- [ ] Notification permissions enabled on devices

### Citizen Tests

- [ ] Receives complaint status update ‚Üí Routes to `/track-complaints`
- [ ] Receives admin chat reply ‚Üí Routes to `/chat`
- [ ] Receives urgent notice ‚Üí Routes to `/dashboard`
- [ ] Receives news alert ‚Üí Routes to `/dashboard`

### Contractor Tests

- [ ] Receives task assignment ‚Üí Routes to `/contractor/task-detail`
- [ ] Receives complaint status update ‚Üí Routes to `/contractor/tasks`
- [ ] Receives admin chat message ‚Üí Routes to `/contractor/chat`
- [ ] Receives urgent notice ‚Üí Routes to `/contractor/dashboard`

### Admin Tests

- [ ] Receives new complaint ‚Üí Routes to `/admin/complaints`
- [ ] Receives citizen chat message ‚Üí Routes to `/admin/chat/detail` (citizen)
- [ ] Receives contractor chat message ‚Üí Routes to `/admin/chat/detail` (contractor)
- [ ] Receives urgent notice ‚Üí Routes to `/admin/dashboard`

### Edge Cases

- [ ] Unknown notification type ‚Üí Routes to dashboard
- [ ] No user logged in ‚Üí No navigation, logs error
- [ ] Missing data fields ‚Üí Graceful fallback
- [ ] App in background ‚Üí Correct navigation
- [ ] App terminated ‚Üí Correct navigation on tap

---

## Debugging Guide

### Enable Debug Logging

In `notification_service.dart`, verify these logs are present:

```dart
print('üß≠ Notification data: $data');
print('üß≠ Notification type: $type');
print('üë§ User role: $userRole');
```

### Check Cloud Functions Logs

```bash
# Real-time logs
firebase functions:log --only onChatMessage

# Filter by time
firebase functions:log --only onChatMessage --since 1h
```

### Check Firestore FCM Tokens

In Firebase Console:

1. Go to Firestore Database
2. Navigate to `admins/{userId}`
3. Check `fcmTokens` array:
   ```json
   [
     {
       "token": "fcm_token_here",
       "platform": "android",
       "lastActive": Timestamp,
       "addedAt": Timestamp
     }
   ]
   ```

### Verify Notification Delivery

In Firebase Console:

1. Cloud Messaging ‚Üí Send test message
2. Add FCM token
3. Add data payload:
   ```json
   {
     "type": "user_chat_message",
     "userId": "test-user-id",
     "userType": "citizen"
   }
   ```
4. Send & verify

---

## Test Results Template

### Test Session: [Date]

**Environment:**

- Flutter Version: **\_\_**
- Firebase SDK Version: **\_\_**
- Test Devices: **\_\_**

**Test Results:**

| Test Case                     | Status  | Notes |
| ----------------------------- | ------- | ----- |
| Chat: Citizen ‚Üí Admin         | ‚úÖ / ‚ùå |       |
| Chat: Admin ‚Üí Citizen         | ‚úÖ / ‚ùå |       |
| Chat: Contractor ‚Üí Admin      | ‚úÖ / ‚ùå |       |
| Chat: Admin ‚Üí Contractor      | ‚úÖ / ‚ùå |       |
| Complaint: New (Admin)        | ‚úÖ / ‚ùå |       |
| Complaint: Status (Citizen)   | ‚úÖ / ‚ùå |       |
| Task: Assignment (Contractor) | ‚úÖ / ‚ùå |       |
| Notice: Urgent (All)          | ‚úÖ / ‚ùå |       |
| Edge: Unknown Type            | ‚úÖ / ‚ùå |       |
| Edge: No User                 | ‚úÖ / ‚ùå |       |

**Issues Found:**

1.
2.
3.

**Overall Status:** ‚úÖ PASS / ‚ùå FAIL

---

## Production Rollout Plan

1. **Phase 1: Internal Testing**

   - Test with development Firebase project
   - Verify all test cases pass
   - Fix any issues found

2. **Phase 2: Beta Testing**

   - Deploy to staging environment
   - Test with beta users (1-2 from each role)
   - Collect feedback

3. **Phase 3: Gradual Rollout**

   - Deploy to 10% of users
   - Monitor logs for errors
   - Increase to 50% if stable
   - Full rollout

4. **Phase 4: Post-Deployment**
   - Monitor crash reports
   - Check navigation analytics
   - Gather user feedback
   - Address any issues

---

**Testing Version:** 1.0  
**Last Updated:** October 27, 2025  
**Next Review:** After deployment
